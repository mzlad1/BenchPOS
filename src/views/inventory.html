<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline';"
    />
    <title>Inventory - MZLAD Billing System</title>

    <!-- Global Styles (shared across pages) -->
    <link rel="stylesheet" href="../styles/global.css" />
    <link rel="stylesheet" href="../styles/inverntory.css" />
  </head>
  <body class="light-mode">
    <div class="app-container">
      <!-- Sidebar Container (will be populated by layout.js) -->
      <div id="sidebar-container"></div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header Container (will be populated by layout.js) -->
        <div id="header-container"></div>

        <!-- Inventory Content -->
        <div class="inventory-container">
          <!-- Inventory Stats -->
          <div class="inventory-stats">
            <div class="stat-card">
              <h3>Total Products</h3>
              <p id="total-products">0</p>
            </div>
            <div class="stat-card">
              <h3>Inventory Value</h3>
              <p id="inventory-value">$0.00</p>
            </div>
            <div class="stat-card">
              <h3>Low Stock Items</h3>
              <p id="low-stock-count">0</p>
            </div>
          </div>

          <!-- Inventory Controls -->
          <div class="inventory-controls">
            <!-- Primary Actions Row -->
            <div class="primary-actions">
              <button id="add-new-btn" class="btn primary-btn">
                <span class="icon">âœš</span> Add New Product
              </button>
              <div class="action-group">
                <button id="export-csv-btn" class="btn secondary-btn">
                  <span class="icon">ðŸ“¤</span> Export CSV
                </button>
                <button id="import-csv-btn" class="btn secondary-btn">
                  <span class="icon">ðŸ“¥</span> Import CSV
                </button>
              </div>
            </div>

            <!-- Search & Filters Row -->
            <div class="search-filter-row">
              <div class="search-bar">
                <div class="enhanced-search">
                  <div class="search-field">
                    <select id="search-filter" class="search-filter">
                      <option value="all">All Fields</option>
                      <option value="sku">SKU</option>
                      <option value="name">Name</option>
                      <option value="category">Category</option>
                    </select>
                    <input
                      type="text"
                      id="product-search"
                      placeholder="Search products..."
                    />
                    <button
                      id="clear-search"
                      class="clear-search"
                      title="Clear search"
                    >
                      Ã—
                    </button>
                  </div>
                  <div id="search-status" class="search-status"></div>
                </div>
              </div>
            </div>

            <!-- Bulk Actions Container -->
            <div class="bulk-actions-container" id="bulk-actions-container">
              <div class="bulk-actions" id="bulk-actions">
                <span id="selected-count">0 items selected</span>
                <select id="bulk-action-select" disabled>
                  <option value="">-- Select Action --</option>
                  <option value="delete">Delete Selected</option>
                  <option value="category">Change Category</option>
                  <option value="stock">Update Stock</option>
                </select>
                <button id="apply-bulk-action" class="btn primary-btn" disabled>
                  Apply
                </button>
              </div>
            </div>
          </div>

          <!-- Products Table -->
          <div class="table-container">
            <table id="products-table">
              <thead>
                <tr>
                  <th class="checkbox-cell">
                    <input type="checkbox" id="select-all-checkbox" />
                  </th>
                  <th>SKU</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Selling Price</th>
                  <th>Cost</th>
                  <th>Profit</th>
                  <th>Stock</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="products-table-body">
                <!-- Loading state example -->
                <tr>
                  <td colspan="9" style="text-align: center; padding: 24px">
                    <div
                      style="
                        display: inline-block;
                        width: 24px;
                        height: 24px;
                        border: 3px solid rgba(67, 97, 238, 0.3);
                        border-radius: 50%;
                        border-top-color: var(--primary-color);
                        animation: rotate 1s infinite linear;
                      "
                    ></div>
                    <div style="margin-top: 8px">Loading products...</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination Container -->
          <div id="pagination-container" class="pagination">
            <div class="pagination-controls">
              <button class="btn pagination-btn" disabled>Â« Previous</button>
              <span class="page-info">Page 1 of 1</span>
              <button class="btn pagination-btn" disabled>Next Â»</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="product-form-title">Add New Product</h2>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <form id="add-product-form">
            <div class="form-group">
              <label for="product-name">Product Name</label>
              <input
                type="text"
                id="product-name"
                name="product-name"
                required
              />
            </div>
            <div class="form-group">
              <label for="product-sku">SKU</label>
              <input type="text" id="product-sku" name="product-sku" />
            </div>
            <div class="form-group">
              <label for="product-category">Category</label>
              <input
                type="text"
                id="product-category"
                name="product-category"
              />
            </div>
            <div class="form-group">
              <label for="product-price">Selling Price ($)</label>
              <input
                type="number"
                id="product-price"
                name="product-price"
                step="0.01"
                min="0"
                required
              />
            </div>
            <div class="form-group">
              <label for="product-cost">Purchase Cost ($)</label>
              <input
                type="number"
                id="product-cost"
                name="product-cost"
                step="0.01"
                min="0"
                required
              />
            </div>
            <div class="form-group">
              <label for="product-stock">Stock Quantity</label>
              <input
                type="number"
                id="product-stock"
                name="product-stock"
                min="0"
                required
              />
            </div>
            <div class="form-actions">
              <button
                type="button"
                class="btn secondary-btn"
                onclick="document.getElementById('product-modal').style.display='none'"
              >
                Cancel
              </button>
              <button type="submit" class="btn primary-btn">
                Save Product
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Category Change Modal -->
    <div id="category-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Change Category</h2>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <p>Select a new category for selected products:</p>
          <div class="form-group">
            <select id="new-category">
              <option value="Electronics">Electronics</option>
              <option value="Office Supplies">Office Supplies</option>
              <option value="Furniture">Furniture</option>
              <option value="Accessories">Accessories</option>
              <option value="new">+ Add New Category</option>
            </select>
          </div>
          <div id="new-category-input" class="form-group" style="display: none">
            <input
              type="text"
              id="new-category-name"
              placeholder="Enter new category name"
            />
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn secondary-btn"
              id="cancel-category"
            >
              Cancel
            </button>
            <button type="button" class="btn primary-btn" id="save-category">
              Apply
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Stock Update Modal -->
    <div id="stock-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Update Stock</h2>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <p>Update stock for selected products:</p>
          <div class="form-group">
            <label>Update Method:</label>
            <select id="stock-update-method">
              <option value="set">Set to value</option>
              <option value="add">Add to current stock</option>
              <option value="subtract">Subtract from current stock</option>
            </select>
          </div>
          <div class="form-group">
            <label>Value:</label>
            <input type="number" id="stock-value" min="0" value="0" />
          </div>
          <div class="form-actions">
            <button type="button" class="btn secondary-btn" id="cancel-stock">
              Cancel
            </button>
            <button type="button" class="btn primary-btn" id="save-stock">
              Apply
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Import Products from CSV</h2>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <div class="import-instructions">
            <p>Upload a CSV file with the following columns:</p>
            <div
              style="
                background: var(--light-gray);
                padding: 8px 12px;
                border-radius: 4px;
                margin: 8px 0;
                font-family: monospace;
                font-size: 13px;
              "
            >
              id,sku,name,category,price,cost,stock
            </div>
            <p>Leave the id column blank for new products.</p>
          </div>
          <div class="form-group">
            <label for="csv-file">Select CSV File:</label>
            <input type="file" id="csv-file" accept=".csv" />
          </div>
          <div class="import-options">
            <div class="form-group">
              <label>
                <input type="checkbox" id="override-existing" checked />
                Update existing products (matched by ID or SKU)
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="add-new-products" checked />
                Add new products
              </label>
            </div>
          </div>
          <div id="csv-preview" class="csv-preview">
            <h3>Preview:</h3>
            <div id="preview-content"></div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn secondary-btn" id="cancel-import">
              Cancel
            </button>
            <button
              type="button"
              class="btn primary-btn"
              id="process-import"
              disabled
            >
              Import Products
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Load Scripts -->
    <script src="../scripts/layout.js"></script>
    <script src="../scripts/activity-logger.js"></script>
    <script src="../scripts/inventory.js"></script>
    <script src="../services/sync-ui.js"></script>

    <script>
      // Initialize page
      document.addEventListener("DOMContentLoaded", async function () {
        // First validate user access
        try {
          const user = await window.api.getCurrentUser();
          if (!user) {
            window.location.href = "../views/login.html";
            return;
          }

          // Check role-based access
          if (user.role === "cashier") {
            alert("You do not have permission to access the Inventory page.");
            window.location.href = "../index.html";
            return;
          }

          // Initialize layout with current page identifier
          await LayoutManager.init("inventory");

          console.log("User authorized to access Inventory page");

          // Initialize sync UI (if exists)
          if (typeof window.initSyncUI === "function") {
            window.initSyncUI();
          }
        } catch (error) {
          console.error("Access control error:", error);
          window.location.href = "../views/login.html";
        }
      });
    </script>
  </body>
</html>
